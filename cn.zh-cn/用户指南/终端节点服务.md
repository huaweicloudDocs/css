# 终端节点服务<a name="css_01_0082"></a>

云搜索服务提供了终端节点服务，用户开启了此服务后，可以通过内网域名访问集群。在开启终端节点服务时，系统会默认给用户创建一个终端节点。创建终端节点需要有相关的权限，请参考[VPC终端节点权限管理](https://support.huaweicloud.com/productdesc-vpcep/vpcep_pd_0001.html)。

>![](public_sys-resources/icon-caution.gif) **注意：** 
>公网访问和终端节点服务功能使用的是同一个负载均衡。如果开启了公网访问白名单，由于白名单是作用在负载均衡上面，会同时限制公网访问集群和内网通过VPCEP访问集群的IP。此时需要在公网访问白名单中添加一个网络白名单198.19.128.0/20，该白名单用来放通经过VPCEP的流量。

## 创建集群时开启终端节点服务<a name="section115745793915"></a>

1.  登录云搜索服务管理控制台。
2.  在创建集群页面，“高级配置“选择“自定义“后，开启终端节点服务。

    **图 1**  开启终端节点服务（1）<a name="fig2036684915310"></a>  
    ![](figures/开启终端节点服务（1）.png "开启终端节点服务（1）")

    -   “创建内网域名“：如果开启，系统将会自动为用户创建一个内网域名，可以通过内网域名访问集群。
    -   “终端节点服务白名单“：您可以在“终端节点服务白名单“中添加需要授权的账号ID，只要其账号ID被添加到终端节点服务白名单中，，就可以通过内网域名或者节点IP访问集群。

        如果需要添加多个账号，可以通过单击![](figures/icon-add-css.png)进行添加。也可以通过单击“操作“列下面的“删除“，进行删除不允许访问的账号。

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >-   授权账号ID配置成\*，则表示允许全部用户访问该集群。
    >-   需要授权的账号ID可在“我的凭证”中进行查看。
    >-   集群开启终端节点服务之后，终端节点将按需进行收费，终端节点的费用将由用户进行支付，详细的计费方式请参考[终端节点计费说明](https://support.huaweicloud.com/productdesc-vpcep/zh-cn_topic_0131645197.html)。


## 已有集群终端节点服务管理<a name="section12521512195113"></a>

如果创建集群时未开启终端节点服务，集群创建成功后，可以通过如下步骤进行开启。

1.  登录云搜索服务管理控制台。
2.  在集群管理页面，单击需要开启终端节点服务的集群名称，进入集群基本信息页面。
3.  选择“终端节点服务“，在“终端节点服务“右侧单击开关，打开集群的终端节点服务功能。

    ![](figures/icon-close.png)表示关闭终端节点服务功能，![](figures/icon-open-hws.png)表示打开终端节点服务功能。

    在弹出的提示框中，您可以根据需求，选择是否开启内网域名。选择创建内网域名后，可以通过内网域名访问集群。

    **图 2**  开启终端节点服务（2）<a name="fig136581858143614"></a>  
    ![](figures/开启终端节点服务（2）.png "开启终端节点服务（2）")

    >![](public_sys-resources/icon-note.gif) **说明：** 
    >-   开启终端节点服务后，您可以通过终端节点产生的“内网域名“或者“节点IP“访问此集群。详细请参考[通过内网域名或节点IP访问集群](#section19864153679)。
    >-   关闭终端节点服务功能后，所有的用户将不能通过内网域名访问此集群。

4.  单击“是“，开启终端节点服务。
5.  （可选）打开终端节点服务后，您可以单击“终端节点服务白名单“后面的“更新“，更新已有的白名单。
6.  连接管理。

    在终端节点服务页面下，显示所有连接当前终端节点服务的终端节点。您可以对这些终端节点的“连接状态“进行“接受“或者“拒绝“操作。如果对某个终端节点“拒绝“操作之后，其生成的内网域名将不能再访问到当前集群。


## 通过内网域名或节点IP访问集群<a name="section19864153679"></a>

1.  获取内网域名或者节点IP。
    -   当前用户

        登录console控制台，单击集群名称，进入集群“基本信息“页面，选择“终端节点服务“，查看内网域名，如[图3](#fig18797175384620)。

        **图 3**  查看内网域名和节点IP信息（1）<a name="fig18797175384620"></a>  
        ![](figures/查看内网域名和节点IP信息（1）.png "查看内网域名和节点IP信息（1）")

    -   其他用户

        如果您申请了终端节点，登录[终端节点控制台](https://www.huaweicloud.com/product/vpcep.html)，单击“ID“，进入终端节点基本信息页面查看内网域名。如[图4](#fig47931947135519)。

        **图 4**  查看内网域名和节点IP信息（2）<a name="fig47931947135519"></a>  
        ![](figures/查看内网域名和节点IP信息（2）.png "查看内网域名和节点IP信息（2）")

2.  在弹性云服务器中，直接通过cURL执行API或者开发程序调用****API并执行程序即可使用集群。Elasticsearch操作和接口请参见[《Elasticsearch：权威指南》](https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html)。

    弹性云服务器需要满足如下要求：

    -   为弹性云服务分配足够的磁盘空间。
    -   此弹性云服务器的VPC需要与集群在同一个VPC中，开通终端节点服务后，可以实现跨VPC访问。
    -   此弹性云服务器的安全组需要和集群的安全组相同。

        如果不同，请修改弹性云服务器安全组或配置弹性云服务器安全组的出入规则允许集群所有安全组的访问。修改操作请参见[配置安全组规则](https://support.huaweicloud.com/usermanual-ecs/zh-cn_topic_0030878383.html)。

    -   待接入的CSS集群，其安全组的出方向和入方向需允许TCP协议及9200端口，或者允许端口范围包含9200端口。

    例如，使用cURL执行如下命令，查看集群中的索引信息，集群中的内网访问地址为“vpcep-7439f7f6-2c66-47d4-b5f3-790db4204b8d.region01.huaweicloud.com“，端口为“9200“。

    -   如果接入集群未启用安全模式，接入方式为：

        ```
        curl 'http://vpcep-7439f7f6-2c66-47d4-b5f3-790db4204b8d.region01.huaweicloud.com:9200/_cat/indices'
        ```

    -   如果接入集群已启用安全模式，则需要使用https方式访问，并附加用户名和密码，在curl命令中添加-u选项。

        ```
        curl -u username:password -k 'https://vpcep-7439f7f6-2c66-47d4-b5f3-790db4204b8d.region01.huaweicloud.com:9200/_cat/indices'
        ```



